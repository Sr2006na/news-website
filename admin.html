<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Add Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-storage.js"></script>
</head>
<body>
    <div id="loginSection">
        <h1>Admin Login</h1>
        <form id="loginForm">
            <label for="email">Email:</label>
            <input type="email" id="email" name="email" value="sreenugirikp123@gmail.com" required>
            <br>
            <label for="password">Password:</label>
            <input type="password" id="password" name="password" required>
            <br>
            <button type="submit">Login</button>
        </form>
    </div>

    <div id="adminSection" style="display: none;">
        <h1>Admin Panel</h1>
        <form id="newsForm">
            <label for="title">Title:</label>
            <input type="text" id="title" name="title" required>
            <br>
            <label for="content">Content:</label>
            <textarea id="content" name="content" required></textarea>
            <br>
            <label for="image">Image:</label>
            <input type="file" id="image" name="image" accept="image/*" required>
            <br>
            <!-- Progress Bar -->
            <div id="progressBarContainer" style="display: none;">
                <progress id="progressBar" value="0" max="100"></progress>
                <span id="progressText">0%</span>
            </div>
            <br>
            <button type="submit">Add News</button>
        </form>
        <button id="logoutButton">Logout</button>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBzwTHxw6Y9opozv3AsjCvDQwLYoVB56YE",
            authDomain: "news-website-369.firebaseapp.com",
            projectId: "news-website-369",
            storageBucket: "news-website-369.appspot.com",
            messagingSenderId: "653045591370",
            appId: "1:653045591370:web:7c3bff0cc9df76a563a5b3",
            measurementId: "G-MR1QM00EHP"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage(); // Initialize Firebase Storage

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                await auth.signInWithEmailAndPassword(email, password);
                alert('Login successful!');
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('adminSection').style.display = 'block';
            } catch (error) {
                alert('Login failed: ' + error.message);
            }
        });

        // Logout
        document.getElementById('logoutButton').addEventListener('click', () => {
            auth.signOut();
            alert('Logged out successfully!');
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('adminSection').style.display = 'none';
        });

        // Check authentication state
        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('adminSection').style.display = 'block';
            } else {
                document.getElementById('loginSection').style.display = 'block';
                document.getElementById('adminSection').style.display = 'none';
            }
        });

        // Add news to Firestore
        document.getElementById('newsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('title').value;
            const content = document.getElementById('content').value;
            const imageFile = document.getElementById('image').files[0];

            if (!imageFile) {
                alert('Please select an image file.');
                return; // Stop execution if no image is selected
            }

            try {
                // Show progress bar
                document.getElementById('progressBarContainer').style.display = 'block';
                document.getElementById('progressBar').value = 0;
                document.getElementById('progressText').innerText = '0%';

                // Upload image to Firebase Storage
                const storageRef = storage.ref();
                const imageRef = storageRef.child(`news-images/${imageFile.name}`);
                const uploadTask = imageRef.put(imageFile);

                // Track upload progress
                uploadTask.on('state_changed', 
                    (snapshot) => {
                        // Update progress bar
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        document.getElementById('progressBar').value = progress;
                        document.getElementById('progressText').innerText = `${Math.round(progress)}%`;
                    },
                    (error) => {
                        // Handle upload error
                        alert('Upload failed: ' + error.message);
                        document.getElementById('progressBarContainer').style.display = 'none';
                    },
                    async () => {
                        // Upload complete
                        const imageUrl = await uploadTask.snapshot.ref.getDownloadURL();

                        // Add news to Firestore
                        await db.collection('news').add({
                            title,
                            content,
                            imageUrl,
                            date: new Date()
                        });
                        alert('News added successfully!');
                        document.getElementById('newsForm').reset();
                        document.getElementById('progressBarContainer').style.display = 'none';
                    }
                );
            } catch (error) {
                alert('Failed to add news: ' + error.message);
                document.getElementById('progressBarContainer').style.display = 'none';
            }
        });
    </script>
</body>
</html>